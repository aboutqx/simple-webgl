<style>
#container div{
font-size:18px;margin-top:20px;margin-left:5px;display:inline-block;background:#ccc;height:30px;line-height:30px;padding:0 5px;border-radius:4px;cursor: pointer;
}
#container .active{
	background: #CD7;
}
</style>
<canvas></canvas>
<input type="file" id="change-target">
<div id="container" style="max-width: 739px;"></div>
<script src="../bundle.js"></script>
<script>
(function(){
var effects=[
'normal',
'brightness','saturation','desaturate','contrast','negative','hue','desaturateLuminance','sepia','brownie','vintagePinhole','kodachrome','technicolor','polaroid','shiftToBGR',

'detectEdges','sobelX','sobelY','sharpen','emboss','triangleBlur',

'1977','Brannan','Gotham','Hefe','Inkwell','Lord Kelvin','Nashville','X-PRO II','grayFocus','cartoon'
];
var presets = [
	{name: 'none'},
	{name: 'negative'},
	{name: 'brightness', args:[1.5]},
	{name: 'saturation', args:[1.5]},
	{name: 'contrast', args:[1.5]},
	{name: 'hue', args:[180]},
	{name: 'desaturate'},
	{name: 'desaturateLuminance'},
	{name: 'brownie'},
	{name: 'sepia'},
	{name: 'vintagePinhole'},
	{name: 'kodachrome'},
	{name: 'technicolor'},
	{name: 'detectEdges'},
	{name: 'sharpen'},
	{name: 'emboss'},
	{name: 'triangleBlur', args:[30]},
	{name: 'grayFocus',arg:['r']},
	{name: 'cartoon'}
];
var container=document.getElementById('container'),canvas=document.querySelector('canvas'),file=document.querySelector('#change-target');
effects.forEach(function(effect){
	var div=document.createElement('div');
	div.className='effect';
	div.innerHTML =effect;
	container.appendChild(div);
})


var img = new Image(), filter;
img.src = 'p7.jpg';
img.onload = function() {
	canvas.width=img.width;
	canvas.height=img.height;
	try {
		filter = new WebGLImageFilter();
	}catch( err ) { console.error(err)}
	
	var filteredImage = filter.render(img);

	container.addEventListener('click',function(e){
		if(e.target.className=='effect'){
			container.querySelector('.active')&&(container.querySelector('.active').className='effect');
			e.target.className='effect active';
			var effect=e.target.innerHTML;
			filter.reset();
			if(!(has(presets,'name',effect)==-1)){
				if(presets[has(presets,'name',effect)].args)
				filter.addFilter(effect,presets[has(presets,'name',effect)].args[0]);
				else filter.addFilter(effect);
			}else if(!(['1977','Brannan','Hefe','Lord Kelvin','Nashville','X-PRO II','Gotham'].indexOf(effect)==-1)){
				filter.addFilter('instagramFilter',effect);
				if(effect=='Gotham') filter.addFilter('Inkwell');
			}
			else if(effect=='normal'){
				var filteredImage = filter.render(img);
				return;
			}
			else filter.addFilter(effect);
			filter.prepare();
			var filteredImage = filter.render(img);
		}
	})
	
	//for dubug
	document.querySelector('.effect:last-child').click()
	animation();
}
file.addEventListener('change',function(e){
	var t=e.target.files[0];
	if(isImg(t.name)){
		var reader = new FileReader();
        reader.addEventListener('load', function(event) {
            img.src = event.target.result;
            img.onload = function(){//覆盖原方法
            	document.querySelector('.effect:last-child').click()
            }
        }, false);
        reader.readAsDataURL(t);
	}else if(isVideo()){

	} 
})


function animation(){
	requestAnimationFrame(animation)
	filter.render(img)
}
function isImg(name){
	var allowedExtension = ['jpeg', 'jpg', 'png', 'gif', 'bmp'];
	var t=name.split('.').pop().toLowerCase()
	 for(var index in allowedExtension) {
        if(t === allowedExtension[index]) {
            isValidFile = true; 
            break;
        }
    }
    return isValidFile;
}
function isVideo(){
	var allowedExtension = ['mp4'];
	var t=name.split('.').pop().toLowerCase()
	 for(var index in allowedExtension) {
        if(t === allowedExtension[index]) {
            isValidFile = true; 
            break;
        }
    }
    return isValidFile;
}
function has(arr, key, value) { //array child object has key-value
    if (!arr||!arr.length) return -1;
    for (var i = 0; i < arr.length; i++) {
        if (arr[i][key] == value) return i;
    }
    return -1;
}
})()
</script>