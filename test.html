<script id="vshader" type="whatever">
attribute vec4 a_position;
varying vec2 v_texcoord;

void main() {
  gl_Position = vec4(a_position.x,-a_position.y,0.0,1.0);
  v_texcoord = a_position.xy * 0.5 + 0.5;
}    
</script>
<script id="fshader" type="whatever">
precision mediump float;
varying vec2 v_texcoord;
uniform sampler2D u_sampler;
void main() {

    gl_FragColor = texture2D(u_sampler, v_texcoord);
}
</script>
<canvas id="c" width="600" height="600"></canvas>
<script src="matrixTrans.js"></script>
<script src="webgl-utils.js"></script>
<script src="webglProgram.js"></script>
<script>

vertexShader= [
  "attribute vec2 position;",
  "void main() {",
  'gl_Position = vec4(pos.x, pos.y, 0.0, 1.);',
  "}"
].join("\n");

fragmentShader= [
"#ifdef GL_ES",
"precision highp float;",
"#endif",
"uniform sampler2D from, to;",
"uniform float progress;",
"uniform vec2 resolution;",

/*
  (C) Sergey Kosarevsky, 2014
  
  Available under the terms of MIT license
  http://www.linderdaum.com
*/

"void main(void)",
"{",
  "float Radius = 1.0;",

  "float T = progress;",

  "vec2 UV = gl_FragCoord.xy / resolution.xy;",

  "UV -= vec2( 0.5, 0.5 );",

  "float Dist = length(UV);",

  "if ( Dist < Radius )",
  "{",
    "float Percent = (Radius - Dist) / Radius;",
    "float A = ( T <= 0.5 ) ? mix( 0.0, 1.0, T/0.5 ) : mix( 1.0, 0.0, (T-0.5)/0.5 );",
    "float Theta = Percent * Percent * A * 8.0 * 3.14159;",
    "float S = sin( Theta );",
    "float C = cos( Theta );",
    "UV = vec2( dot(UV, vec2(C, -S)), dot(UV, vec2(S, C)) );",
  "}",
  "UV += vec2( 0.5, 0.5 );",

  "vec4 C0 = texture2D( from, UV );",
  "vec4 C1 = texture2D( to, UV );",

  "gl_FragColor = mix( C0, C1, T );",
"}",
].join("\n")

var canvas = document.getElementById("c");
var gl = initWebGL(canvas);

function initWebGL(canvas) {
  gl = null;
  
  gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
  // If we don't have a GL context, give up now
  if (!gl) {
    alert("Unable to initialize WebGL. Your browser may not support it.");
  }
  return gl;
}

var verts = [
      1,  1,
     -1,  1,
     -1, -1,
      1,  1,
     -1, -1,
      1, -1,
];   
var vertBuffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, vertBuffer);
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verts), gl.STATIC_DRAW);
gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
gl.enableVertexAttribArray(0);

var program = createProgramFromScripts(gl, ["vshader", "fshader"], ["a_position"]);
gl.useProgram(program);

// create an empty texture
var tex = gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D, tex);
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
gl.clearColor(1, 1, 0, 1); // green;
gl.clear(gl.COLOR_BUFFER_BIT);
// Create a framebuffer and attach the texture.
var fb = gl.createFramebuffer();
gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, tex, 0);



// Now draw with the texture to the canvas
// NOTE: We clear the canvas to red so we'll know
// we're drawing the texture and not seeing the clear
// from above.


var image=new Image();
image.src="koala.jpg";
image.onload=function(){
    //gl.viewport(200,200,600,600);
    var _currentProgram = new WebGLProgram(gl,vertexShader,fragmentShader);
    //[x, y, u, v] * 6
    var vertices = new Float32Array([
        -1, -1, 0, 1,  1, -1, 1, 1,  -1, 1, 0, 0,
        -1, 1, 0, 0,  1, -1, 1, 1,  1, 1, 1, 0
      ]);
    _vertexBuffer = gl.createBuffer(),
    gl.bindBuffer(gl.ARRAY_BUFFER, _vertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

    var floatSize = Float32Array.BYTES_PER_ELEMENT;
    var vertSize = 4 * floatSize;
    gl.enableVertexAttribArray(_currentProgram.attribute.position);
    gl.vertexAttribPointer(_currentProgram.attribute.pos, 2, gl.FLOAT, false, vertSize , 0 * floatSize);
    gl.enableVertexAttribArray(_currentProgram.attribute.uv);
    gl.vertexAttribPointer(_currentProgram.attribute.uv, 2, gl.FLOAT, false, vertSize, 2 * floatSize);
    
    gl.uniformMatrix4fv(pUniform, false, new Float32Array(perspectiveMatrix.flatten()));
    
    var _sourceTexture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, _sourceTexture);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST); 
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);

    gl.bindFramebuffer(gl.FRAMEBUFFER,null);
    

    gl.drawArrays(gl.TRIANGLES, 0, 6);
    gl.bindTexture(gl.TEXTURE_2D, null);
    // Render to the texture (using clear because it's simple)

}

</script>